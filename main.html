<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIP 校正サポートツール</title>
    <!-- Tailwind CSSを読み込んで、モダンなデザインを適用します -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 日本語フォントが美しく表示されるように設定します */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 結果表示用のスタイル */
        .suggestion-card {
            border-left: 4px solid;
            transition: background-color 0.3s;
        }
        .suggestion-card:hover {
            background-color: #f0f4ff;
        }
        /* ハイライト用のスタイル */
        #highlighted-output mark.replace { background-color: #fef08a; } /* 修正候補あり */
        #highlighted-output mark.warning { background-color: #fed7aa; } /* 警告 */
        /* ローディングスピナー */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">📝 CLIP 校正サポートツール</h1>
            <p class="mt-2 text-lg text-gray-600">サークル記事の品質を、もっと手軽に向上させよう。</p>
            <button id="view-rules-button" class="absolute top-0 right-0 bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                校正ルール一覧を見る
            </button>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div>
                <label for="text-input" class="block text-xl font-semibold mb-2 text-gray-700">1. 校正したい文章を入力</label>
                <p class="text-sm text-gray-500 mb-4">下のボックスに記事の文章を貼り付けてください。</p>
                <textarea 
                    id="text-input" 
                    class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                    placeholder="ここに記事の文章を貼り付けてください..."
                ></textarea>
            </div>

            <!-- ★修正★ ボタンを3つに分離 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                <button 
                    id="check-button" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-md"
                >
                    ルールベース校正
                </button>
                <button 
                    id="gemini-proofread-button"
                    class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-full hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                    ✨ Geminiで高度な校正
                </button>
                <button 
                    id="gemini-sns-button"
                    class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-6 rounded-full hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-4 focus:ring-green-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    📝 SNS投稿案を作成
                </button>
            </div>

            <div id="gemini-result-container" class="mt-10 hidden">
                <h2 id="gemini-result-title" class="text-2xl font-bold mb-4 text-gray-800 border-b-2 border-purple-200 pb-2"></h2>
                <div id="gemini-result-area" class="w-full min-h-[100px] p-4 space-y-6">
                    <!-- AIの提案がここに表示されます -->
                </div>
            </div>

            <div class="mt-10">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ハイライト表示 (ルールベース)</h2>
                <div id="highlighted-output" class="w-full min-h-[150px] p-4 bg-gray-50 border border-gray-300 rounded-lg whitespace-pre-wrap leading-relaxed">
                    <p class="text-gray-400">校正を実行すると、ここにハイライトされた文章が表示されます。</p>
                </div>
            </div>

            <div class="mt-10">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">校正結果リスト (ルールベース)</h2>
                <div 
                    id="result-area" 
                    class="w-full min-h-[100px] p-4 bg-gray-50 border-dashed border-gray-300 rounded-lg space-y-4"
                >
                    <p id="initial-message" class="text-gray-500">ここに校正結果がリスト形式で表示されます。</p>
                </div>
            </div>

        </main>

        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>&copy; 2024 CLIP with コーディングパートナー</p>
        </footer>

    </div>

    <div id="rules-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">校正ルール一覧</h2>
                <p class="text-gray-500 mt-1">現在、このツールには以下のルールが登録されています。</p>
            </div>
            <div id="rules-list-container" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t text-right rounded-b-2xl">
                <button id="close-modal-button" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 漢字判定ロジック ---
        const joyoKanjiSet = new Set("亜哀愛悪握圧扱安暗案以位依偉囲委威尉意慰易為異移維緯胃衣違遺医域育一壱逸稲芋印員因姻引飲院陰隠韻右宇羽雨唄鬱浦運雲永泳英映栄営詠鋭液疫益駅悦謁越閲円園宴延援沿演炎煙猿縁遠鉛塩汚凹央奥往応押横欧殴王翁黄沖億屋憶乙卸恩温穏音下化仮何価佳加可夏嫁家寡科暇果架歌河火禍稼箇花荷華菓課貨過蚊我画芽賀雅餓介会解回塊壊快怪悔懐戒拐改械海灰界皆絵開階塊楷諧劾外咳害崖慨概涯街該骸垣柿各角拡革格核殻獲確穫覚角較郭閣隔革学岳楽額掛潟割喝括活渇滑葛褐轄且株釜鎌刈干刊甘汗缶含勧巻喚堪完官寛干幹患感慣憾換敢棺款歓汗漢環甘監看管簡緩缶艦観貫還鑑間閑関陥館丸含岸巌玩眼頑顔願企伎危喜器基奇寄岐希幾忌揮机旗既期棋棄機帰気汽畿祈季紀規記貴起軌輝飢騎鬼亀儀戯擬欺犠疑義議菊吉喫詰却客脚虐逆丘久休及吸宮弓急救朽求泣球究窮級糾給旧牛去居巨拒拠挙虚許距魚御漁凶共叫狂京享供競共凶協匡卿叫喬境峡強彊怯恐恭挟教橋況狂狭矯胸脅興郷鏡響驚仰凝暁業局曲極玉勤均斤琴禁筋緊菌襟謹近金吟銀九句区苦駆具愚虞空偶遇隅串屈掘窟熊繰君訓勲薫軍郡群兄刑形系径茎係型契計恵啓掲渓経蛍敬景軽傾携継詣慶憬稽憩鶏迎鯨隙劇撃激桁欠穴血決結傑潔月犬件見券肩建研県倹兼剣拳軒圏堅検嫌権犬憲絹県肩見謙賢軒遣険顕験元原厳幻弦減源玄現言限個古呼固孤己庫弧戸故枯湖誇雇顧鼓五互伍午呉後娯悟碁語誤護口工公勾孔巧広甲交光向后好江考行坑孝抗攻更効幸拘肯侯厚恒洪皇紅耕考航荒行衡講貢購郊酵鉱鋼降項香高鴻剛号合拷豪克告国穀酷黒獄腰骨込今困墾恨根混紺魂墾懇左佐沙査砂唆差詐鎖座挫再最哉塞妻宰彩才採栽歳済災砕祭斎細菜裁載際剤在材罪財坂咲崎作削搾昨策索錯桜冊刷察撮擦札殺雑皿三傘参山惨散桟産算蚕賛酸斬暫残仕伺使刺司史嗣四士始姉姿子屍市師志思指支施旨枝止死氏祉私糸紙紫肢脂至視詞詩試誌諮資賜雌飼歯事似侍児字寺慈持時次滋治璽磁示耳自辞鹿式識軸七𠮟失室質実蔀湿漆疾執湿嫉捨写射捨赦斜煮社者謝車遮蛇邪借勺尺爵酌釈錫若寂弱主取守手朱殊狩珠種趣酒首儒受授樹需囚収周宗就州修愁拾舟秀週酬集醜蹴衆襲秋終習臭舟衆襲週蹴就酬集醜住充十従縦重銃獣柔汁渋獣縦重祝宿淑粛縮塾熟出術述俊春瞬准循旬殉準潤盾純巡遵順処初所暑署書諸助叙女序徐除傷償勝匠升召哨商唱嘗奨妾娼宵将小少尚庄床彰承抄招掌捷昇昌昭晶松梢樟樵沼消渉焼焦照症省硝礁祥称章笑粧紹肖衝訟証詔詳象賞醤鉦鍾鐘障鞘上丈丞乗冗剰城場壌嬢常情条杖浄状畳蒸譲醸錠嘱飾植殖織職色触食辱伸信侵唇娠寝審心慎振新晉森榛浸深申疹真神秦紳臣薪親診身辛針震人仁刃塵壬尋甚尽腎訊迅陣酢図吹垂帥推水炊睡粋衰遂酔錘随髄崇数枢据杉菅頗雀裾澄清牲生盛精聖声製西誠誓請逝青静斉税蹟隻席惜斥昔析石積籍績責赤跡切拙接摂折設窃節説雪絶舌仙先千占宣専川戦扇栓泉浅洗染潜旋線繊羨腺舛船薦詮蟺選遷銭銑鮮前善漸然全禅繕膳塑措疎礎双壮早争走奏相荘草送倉捜挿桑巣掃曹曽爽窓創喪痩葬装僧想層総遭槽踪操燥霜騒藻造像増憎臓蔵贈造促側則即息捉束測足速俗属賊続卒率存村孫尊損遜他多太汰詑唾堕妥惰打柁舵楕陀駄体堆対耐帯待怠態替泰滞胎袋貸退逮隊代台大第題滝宅托択拓沢濯琢託鐸濁諾茸凧蛸只叩但達辰奪脱棚谷誰丹単嘆担探淡炭短端胆誕鍛団壇弾断暖段男談値知地弛恥智池痴稚置致蜘遅馳築畜竹筑蓄逐秩窒茶嫡着中仲宙忠抽昼柱注虫衷鋳駐著貯丁弔庁兆町長挑帳張彫眺釣頂鳥朝貼超腸跳徴嘲潮澄調聴懲直勅捗沈珍朕陳賃鎮追椎墜通痛塚漬坪爪鶴低呈廷弟定底抵邸亭貞帝訂庭逓停偵堤提程艇締諦泥的笛摘滴適敵溺迭哲鉄徹撤天典店添展点転塡殿電兎吐堵塗妬都渡途奴怒倒凍唐塔塘套悼搭東桃透盗陶塔棟湯痘登答等筒統稲踏糖頭謄藤闘騰同洞胴動堂童道働銅導瞳峠匿特得督徳篤毒独読凸突届屯豚頓曇鈍内縄南軟難二尼弐匂肉虹日入乳尿任妊忍認寧熱年念捻粘燃悩納能脳農濃把波派破覇馬婆罵拝杯背肺俳配排敗廃輩売倍梅培陪媒買賠白伯拍泊迫剥舶博薄麦漠縛爆箱箸畑肌八鉢発髪伐抜罰閥反半氾犯帆汎伴判坂阪板版班畔般販斑飯搬煩頒範繁藩晩番蛮盤比皮妃否批彼披肥非卑飛疲秘被悲扉費碑罷避尾眉美備微鼻膝肘匹必泌筆姫百氷表俵票評漂標苗秒病描猫品浜貧賓頻敏瓶不夫父付布扶府怖阜附訃負赴浮婦符富普腐敷膚賦譜侮武部舞封風伏服副幅復福腹複覆払沸仏物粉紛雰噴墳憤奮分文聞丙平兵併並柄陛閉塀幣弊蔽餅米壁璧癖別蔑片辺返変偏遍編弁便勉歩保哺捕補舗母募墓慕暮簿方包芳邦奉宝抱放法泡胞俸倣峰砲崩訪報蜂豊飽褒縫亡乏忙坊妨忘防房肪某冒剖紡望傍帽棒貿貌暴膨謀頬北木朴牧睦僕墨撲没勃堀本奔翻凡盆麻摩磨魔毎妹枚昧埋幕膜枕又末抹万満慢漫未味魅岬密蜜脈妙民眠矛務無夢霧娘名命明迷冥盟銘鳴滅免面綿麺茂模毛妄盲耗猛網目黙門紋問冶夜野弥厄役約訳薬躍闇由油喩愉諭輸癒唯友有勇幽悠郵湧猶裕遊雄誘憂融優与予余誉預幼用羊妖洋要容庸揚揺葉陽溶腰様瘍踊窯養擁謡曜抑沃浴欲翌翼拉裸羅来雷頼絡落酪辣乱卵覧濫藍欄吏利里理痢裏履璃陸陸立律慄略柳流留竜粒隆硫侶旅虜慮了両良料涼猟陵量僚領寮療糧力緑林厘倫輪隣臨瑠涙累塁類令礼冷励戻例鈴零霊隷齢麗暦歴列劣烈裂恋連廉練錬呂炉賂路露老労弄郎朗浪廊楼漏籠六録麓論和話賄脇惑枠湾腕");
        const clipSpecificAllowedKanji = new Set(['應', '絆', '則', '叶', '嬉']);
        function isAllowedKanji(char) { return joyoKanjiSet.has(char) || clipSpecificAllowedKanji.has(char); }

        // --- 校正ルールの定義 ---
        const proofreadingRules = [
            { type: 'replace', find: /コンピュータ(?!ー)/g, replace: 'コンピューター', reason: 'カタカナ語の長音ルールに基づき、「コンピューター」と表記します。' },
            { type: 'replace', find: /ユーザ(?!ー)/g, replace: 'ユーザー', reason: 'カタカナ語の長音ルールに基づき、「ユーザー」と表記します。' },
            { type: 'replace', find: /:(\d)(?!\d)/g, replace: (match, p1) => `:0${p1}`, reason: '時刻の「分」が1桁の場合は、先頭に0を追加します。(例: 9:05)' },
            { type: 'replace', find: /今年度/g, replace: '本年度', reason: '「今年度」は使わず、「本年度」と表記します。' },
            { type: 'replace', find: /明年度/g, replace: '来年度', reason: '「明年度」は使わず、「来年度」と表記します。' },
            { type: 'warning', find: /\[こちら\]/g, reason: 'リンク先がわかりにくいアンカータイトルは避けるべきです。「こちら」ではなく、リンク先のタイトルなどを記載してください。' },
            { type: 'replace', find: /〜/g, replace: '-', reason: '数字・日付の範囲を表すには半角ハイフン「-」を使います。' },
            { type: 'replace', find: /,/g, replace: '、', reason: '読点は全角「、」を使用します。半角カンマは修正対象です。' },
            { type: 'replace', find: /｢/g, replace: '「', reason: 'カギ括弧は全角を使用します。' },
            { type: 'replace', find: /｣/g, replace: '」', reason: 'カギ括弧は全角を使用します。' },
            { type: 'replace', find: /･/g, replace: '・', reason: '中点は全角を使用します。' },
            { type: 'warning', find: /但し/g, reason: '「但し」は使わず、ひらがなで「ただし」と表記します。' },
            { type: 'warning', find: /又/g, reason: '「又」は使わず、ひらがなで「また」と表記します。' },
            { type: 'warning', find: /因る/g, reason: '「因る」は使わず、ひらがなで「よる」と表記します。' },
            { type: 'warning', find: /遡る/g, reason: '「遡る」は使わず、ひらがなで「さかのぼる」と表記します。' },
            { type: 'replace', find: /慶應生/g, replace: '塾生', reason: '「慶應生」は「塾生」と表記します。' },
            { type: 'warning', find: /元旦の朝/g, reason: '「元旦」は元日の朝を指すため、「の朝」は不要です。「元旦」または「元日」に修正してください。' },
            { type: 'warning', find: /過半数を超える/g, reason: '「過半数」は半分を超えるという意味です。「過半数を占める」などの表現を検討してください。' },
            { type: 'replace', find: /慶応/g, replace: '慶應', reason: '「慶応」は「慶應」に修正します。' },
            { type: 'replace', find: /一人一人/g, replace: '一人ひとり', reason: '「一人一人」は「一人ひとり」と表記します。' },
            { type: 'replace', find: /（/g, replace: '(', reason: '括弧は半角に修正します。' },
            { type: 'replace', find: /）/g, replace: ')', reason: '括弧は半角に修正します。' },
            { type: 'replace', find: /，/g, replace: '、', reason: '読点は全角「、」を使用します。' },
            { type: 'replace', find: /[？！]/g, replace: (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0), reason: '疑問符・感嘆符は半角を使用します。' },
            { type: 'replace', find: /[．｡]/g, replace: '。', reason: '句点は全角「。」を使用します。' },
            { type: 'replace', find: /様々/g, replace: 'さまざま', reason: '「様々」はひらがなで「さまざま」と表記します。' },
            { type: 'replace', find: /色々/g, replace: 'いろいろ', reason: '「色々」はひらがなで「いろいろ」と表記します。' },
            { type: 'replace', find: /各々/g, replace: 'おのおの', reason: '「各々」はひらがなで「おのおの」と表記します。' },
            { type: 'replace', find: /私達/g, replace: '私たち', reason: '「私達」は「私たち」と表記するのが一般的です。' },
            { type: 'replace', find: /して欲しい/g, replace: 'してほしい', reason: '補助動詞の「ほしい」はひらがなで表記します。' },
            { type: 'replace', find: /賑わい/g, replace: 'にぎわい', reason: '「賑わい」はひらがなで「にぎわい」と表記することが推奨されます。' },
            { type: 'replace', find: /お疲れ様/g, replace: 'お疲れさま', reason: '「お疲れ様」は「お疲れさま」とひらがなで表記することが推奨されます。' },
            { type: 'replace', find: /的を得る/g, replace: '的を射る', reason: '「的を得る」は誤用です。「的を射る」が正しい表現です。' },
            { type: 'replace', find: /違和感を感じる/g, replace: '違和感を覚える', reason: '「違和感を感じる」は二重表現です。「違和感を覚える」を使いましょう。' },
            { type: 'replace', find: /慶早/g, replace: '早慶', reason: '「慶早」ではなく「早慶」と表記します。' },
            { type: 'replace', find: /[０-９]/g, replace: (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0), reason: '数字は半角で表記します。' },
            { type: 'warning', find: /昨日|今日|明日|今朝|昨夜/g, reason: '相対的な日付表現です。公開日によっては意図しない日付になる可能性があります。「〇月〇日」のような絶対的な表記を検討してください。' },
        ];

        // --- HTML要素の取得 ---
        const textInput = document.getElementById('text-input');
        const checkButton = document.getElementById('check-button');
        const geminiProofreadButton = document.getElementById('gemini-proofread-button');
        const geminiSnsButton = document.getElementById('gemini-sns-button');
        const resultArea = document.getElementById('result-area');
        const highlightedOutput = document.getElementById('highlighted-output');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const geminiResultTitle = document.getElementById('gemini-result-title');
        const geminiResultArea = document.getElementById('gemini-result-area');
        const viewRulesButton = document.getElementById('view-rules-button');
        const rulesModal = document.getElementById('rules-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const rulesListContainer = document.getElementById('rules-list-container');

        // --- Gemini API連携 ---
        async function callGeminiApi(text, mode, retries = 3, delay = 1000) {
            console.log(`Gemini APIへリクエストを送信します... モード: ${mode}`);
            
            const apiKey = ""; // Canvas環境では自動的に提供されます
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let systemPrompt, responseSchema;

            if (mode === 'proofread') {
                systemPrompt = `あなたは、慶應義塾大学SFCのWebメディアサークル「SFC CLIP」の優秀な編集アシスタントです。渡された記事テキストを分析し、ルールベースでは検出できない、文章のトーン、構成、表現の自然さなどに関する、より高度で人間的な校正提案を箇条書きの配列で提供してください。`;
                responseSchema = {
                    type: "OBJECT",
                    properties: {
                        advancedFeedback: {
                            type: "ARRAY",
                            items: { type: "STRING" }
                        }
                    }
                };
            } else if (mode === 'sns') {
                systemPrompt = `あなたは、慶應義塾大学SFCのWebメディアサークル「SFC CLIP」の優秀な編集アシスタントです。渡された記事テキストを分析し、以下の3つの項目を日本語で生成してください。
                1. summary: 記事全体の簡潔な要約。
                2. twitterPost: 記事を宣伝するためのX(旧Twitter)用の投稿案。ハッシュタグを効果的に使用すること。
                3. instagramPost: 記事を宣伝するためのInstagram用の投稿案。絵文字を効果的に使用し、読者の興味を引くように工夫すること。`;
                responseSchema = {
                    type: "OBJECT",
                    properties: {
                        summary: { type: "STRING" },
                        twitterPost: { type: "STRING" },
                        instagramPost: { type: "STRING" }
                    }
                };
            }

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        console.warn(`APIレート制限のためリトライします... 残り${retries}回`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiApi(text, mode, retries - 1, delay * 2);
                    }
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    console.log("APIから正常なレスポンスを受信しました。");
                    return JSON.parse(candidate.content.parts[0].text);
                } else {
                    throw new Error("APIレスポンスの形式が不正です。");
                }
            } catch (error) {
                console.error("Gemini APIの呼び出し中にエラーが発生しました:", error);
                if (retries === 0) {
                    throw new Error("APIの呼び出しが上限に達しました。しばらくしてから再試行してください。");
                }
                throw error;
            }
        }
        
        // --- イベントリスナー ---

        geminiProofreadButton.addEventListener('click', async () => {
            const originalText = textInput.value;
            if (!originalText) { alert('文章が入力されていません。'); return; }

            geminiResultContainer.classList.remove('hidden');
            geminiResultTitle.textContent = '✨ Geminiによる高度な校正案';
            geminiResultArea.innerHTML = `<div class="flex items-center justify-center gap-3 text-purple-700"><div class="loader"></div><p>Geminiが文章を解析中です...</p></div>`;

            try {
                const aiResponse = await callGeminiApi(originalText, 'proofread');
                geminiResultArea.innerHTML = `
                    <ul class="list-disc list-inside text-gray-800 space-y-1">
                        ${aiResponse.advancedFeedback.map(item => `<li>${item}</li>`).join('')}
                    </ul>`;
            } catch (error) {
                geminiResultArea.innerHTML = `<p class="text-red-500">エラーが発生しました。AIとの連携に失敗した可能性があります。</p>`;
            }
        });

        geminiSnsButton.addEventListener('click', async () => {
            const originalText = textInput.value;
            if (!originalText) { alert('文章が入力されていません。'); return; }

            geminiResultContainer.classList.remove('hidden');
            geminiResultTitle.textContent = '📝 GeminiによるSNS投稿案';
            geminiResultArea.innerHTML = `<div class="flex items-center justify-center gap-3 text-green-700"><div class="loader" style="border-top-color: #10b981;"></div><p>GeminiがSNS投稿案を作成中です...</p></div>`;

            try {
                const aiResponse = await callGeminiApi(originalText, 'sns');
                geminiResultArea.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">記事の要約</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md text-gray-800">${aiResponse.summary}</div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">X (旧Twitter) 投稿案</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md relative">
                                <pre class="whitespace-pre-wrap font-sans">${aiResponse.twitterPost}</pre>
                                <button onclick="copyToClipboard(this.previousElementSibling.textContent)" class="absolute top-2 right-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-300">コピー</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Instagram 投稿案</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md relative">
                                <pre class="whitespace-pre-wrap font-sans">${aiResponse.instagramPost}</pre>
                                <button onclick="copyToClipboard(this.previousElementSibling.textContent)" class="absolute top-2 right-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-300">コピー</button>
                            </div>
                        </div>
                    </div>`;
            } catch (error) {
                geminiResultArea.innerHTML = `<p class="text-red-500">エラーが発生しました。AIとの連携に失敗した可能性があります。</p>`;
            }
        });

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('コピーしました！');
        }

        checkButton.addEventListener('click', () => {
            const originalText = textInput.value;
            if (!originalText) {
                resultArea.innerHTML = `<p class="text-red-500 text-center">文章が入力されていません。</p>`;
                highlightedOutput.innerHTML = `<p class="text-gray-400">文章を入力してください。</p>`;
                return;
            }

            resultArea.innerHTML = '';
            let issuesFound = 0;
            const matchesToHighlight = [];

            proofreadingRules.forEach(rule => {
                const matches = [...originalText.matchAll(rule.find)];
                if (matches.length > 0) {
                    issuesFound += matches.length;
                    matches.forEach(match => {
                        matchesToHighlight.push({ index: match.index, text: match[0], type: rule.type });
                        displaySuggestion(match[0], rule);
                    });
                }
            });

            const foundBadKanji = new Set();
            const kanjiRegex = /[\u4e00-\u9faf\u3400-\u4dbf]/g;
            let match;
            while ((match = kanjiRegex.exec(originalText)) !== null) {
                const char = match[0];
                if (!isAllowedKanji(char) && !foundBadKanji.has(char)) {
                    issuesFound++;
                    const reason = `「${char}」は常用漢字ではないか、CLIPの規定外の漢字の可能性があります。ひらがなにするか、別の表現を検討してください。`;
                    matchesToHighlight.push({ index: match.index, text: char, type: 'warning' });
                    displaySuggestion(char, { type: 'warning', reason: reason });
                    foundBadKanji.add(char);
                }
            }

            updateHighlightedOutput(originalText, matchesToHighlight, issuesFound);

            if (issuesFound === 0) {
                resultArea.innerHTML = `
                    <div class="text-center p-6 border-green-500 bg-green-50 rounded-lg">
                        <p class="font-bold text-green-700 text-lg">素晴らしいです！</p>
                        <p class="text-green-600">定義されたルールに該当する箇所は見つかりませんでした。</p>
                    </div>
                `;
            }
        });
        
        function displaySuggestion(matchedText, rule) {
            const card = document.createElement('div');
            card.className = 'suggestion-card border-l-4 p-4';
            
            if (rule.type === 'warning') {
                card.classList.add('border-yellow-500', 'bg-yellow-50');
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">【警告】 <code class="bg-yellow-200 text-yellow-800 rounded px-1">${matchedText}</code></p>
                    <p class="text-sm text-gray-600 mt-2">${rule.reason}</p>
                `;
            } else {
                const replacementText = typeof rule.replace === 'function' ? rule.replace(matchedText) : rule.replace;
                card.classList.add('border-blue-500', 'bg-blue-50');
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">指摘箇所： <code class="bg-red-100 text-red-700 rounded px-1">${matchedText}</code></p>
                    <p class="text-gray-600 mt-1">修正候補： <code class="bg-green-100 text-green-700 rounded px-1">${replacementText}</code></p>
                    <p class="text-sm text-gray-500 mt-2">理由： ${rule.reason}</p>
                `;
            }
            resultArea.appendChild(card);
        }

        function updateHighlightedOutput(text, matches, issuesFound) {
            if (issuesFound > 0) {
                matches.sort((a, b) => b.index - a.index);
                let highlightedHTML = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                matches.forEach(match => {
                    const head = highlightedHTML.substring(0, match.index);
                    const tail = highlightedHTML.substring(match.index + match.text.length);
                    const markText = match.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const className = match.type === 'warning' ? 'warning' : 'replace';
                    highlightedHTML = `${head}<mark class="${className}">${markText}</mark>${tail}`;
                });
                highlightedOutput.innerHTML = highlightedHTML.replace(/\n/g, '<br>');
            } else {
                highlightedOutput.innerHTML = `<p class="text-gray-400">指摘事項はありませんでした。</p>`;
            }
        }

        function populateRulesList() {
            let html = '<div class="space-y-4">';
            html += `
                <div class="p-4 border rounded-lg bg-white shadow-sm">
                    <p class="font-mono text-sm">
                        <span class="text-yellow-600 bg-yellow-100 rounded px-2 py-1">常用漢字外の文字</span>
                        <span class="mx-2 text-gray-400">&rarr;</span>
                        <span class="text-gray-600 rounded px-2 py-1">警告を表示</span>
                    </p>
                    <p class="text-sm text-gray-600 mt-2">常用漢字とCLIPで許可された漢字以外が使われている場合に警告します。</p>
                </div>
            `;
            proofreadingRules.forEach(rule => {
                const findText = rule.find.toString().replace(/^\/|\/g$/g, '');
                let replacementHTML;
                if (rule.type === 'warning') {
                    replacementHTML = `<span class="text-gray-600 rounded px-2 py-1">警告を表示</span>`;
                } else {
                    const replacementText = typeof rule.replace === 'function' ? '(自動変換)' : rule.replace;
                    replacementHTML = `<span class="text-green-600 bg-green-100 rounded px-2 py-1">${replacementText}</span>`;
                }

                html += `
                    <div class="p-4 border rounded-lg bg-white shadow-sm">
                        <p class="font-mono text-sm">
                            <span class="text-red-600 bg-red-100 rounded px-2 py-1">${findText}</span>
                            <span class="mx-2 text-gray-400">&rarr;</span>
                            ${replacementHTML}
                        </p>
                        <p class="text-sm text-gray-600 mt-2">${rule.reason}</p>
                    </div>
                `;
            });
            html += '</div>';
            rulesListContainer.innerHTML = html;
        }

        viewRulesButton.addEventListener('click', () => rulesModal.classList.remove('hidden'));
        closeModalButton.addEventListener('click', () => rulesModal.classList.add('hidden'));
        rulesModal.addEventListener('click', (event) => {
            if (event.target === rulesModal) rulesModal.classList.add('hidden');
        });

        populateRulesList();
    </script>
</body>
</html>
