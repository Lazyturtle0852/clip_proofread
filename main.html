<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIP æ ¡æ­£ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã‚“ã§ã€ãƒ¢ãƒ€ãƒ³ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨ã—ã¾ã™ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãŒç¾ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* çµæœè¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .suggestion-card {
            border-left: 4px solid;
            transition: background-color 0.3s;
        }
        .suggestion-card:hover {
            background-color: #f0f4ff;
        }
        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #highlighted-output mark.replace { background-color: #fef08a; } /* ä¿®æ­£å€™è£œã‚ã‚Š */
        #highlighted-output mark.warning { background-color: #fed7aa; } /* è­¦å‘Š */
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">ğŸ“ CLIP æ ¡æ­£ã‚µãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«</h1>
            <p class="mt-2 text-lg text-gray-600">ã‚µãƒ¼ã‚¯ãƒ«è¨˜äº‹ã®å“è³ªã‚’ã€ã‚‚ã£ã¨æ‰‹è»½ã«å‘ä¸Šã•ã›ã‚ˆã†ã€‚</p>
            <button id="view-rules-button" class="absolute top-0 right-0 bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">
                æ ¡æ­£ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã‚’è¦‹ã‚‹
            </button>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div>
                <label for="text-input" class="block text-xl font-semibold mb-2 text-gray-700">1. æ ¡æ­£ã—ãŸã„æ–‡ç« ã‚’å…¥åŠ›</label>
                <p class="text-sm text-gray-500 mb-4">ä¸‹ã®ãƒœãƒƒã‚¯ã‚¹ã«è¨˜äº‹ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea 
                    id="text-input" 
                    class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                    placeholder="ã“ã“ã«è¨˜äº‹ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„..."
                ></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <button 
                    id="check-button" 
                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-md"
                >
                    ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æ ¡æ­£
                </button>
                 <button 
                    id="gemini-phrase-button"
                    class="w-full bg-gradient-to-r from-orange-500 to-amber-600 text-white font-bold py-3 px-6 rounded-full hover:from-orange-600 hover:to-amber-700 focus:outline-none focus:ring-4 focus:ring-orange-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-quote"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.75-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"/></svg>
                    ğŸ” ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
                </button>
                <button 
                    id="gemini-proofread-button"
                    class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-full hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                    âœ¨ é«˜åº¦ãªæ ¡æ­£
                </button>
                <button 
                    id="gemini-sns-button"
                    class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-6 rounded-full hover:from-green-600 hover:to-teal-700 focus:outline-none focus:ring-4 focus:ring-green-300 transform hover:scale-105 transition duration-300 ease-in-out shadow-lg flex items-center justify-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                    ğŸ“ SNSæŠ•ç¨¿æ¡ˆã‚’ä½œæˆ
                </button>
            </div>

            <div id="gemini-result-container" class="mt-10 hidden">
                <h2 id="gemini-result-title" class="text-2xl font-bold mb-4 text-gray-800 border-b-2 pb-2"></h2>
                <div id="gemini-result-area" class="w-full min-h-[100px] p-4 space-y-6">
                    <!-- AIã®ææ¡ˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <div class="mt-10">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º (ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹)</h2>
                <div id="highlighted-output" class="w-full min-h-[150px] p-4 bg-gray-50 border border-gray-300 rounded-lg whitespace-pre-wrap leading-relaxed">
                    <p class="text-gray-400">æ ¡æ­£ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸæ–‡ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>

            <div class="mt-10">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">æ ¡æ­£çµæœãƒªã‚¹ãƒˆ (ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹)</h2>
                <div 
                    id="result-area" 
                    class="w-full min-h-[100px] p-4 bg-gray-50 border-dashed border-gray-300 rounded-lg space-y-4"
                >
                    <p id="initial-message" class="text-gray-500">ã“ã“ã«æ ¡æ­£çµæœãŒãƒªã‚¹ãƒˆå½¢å¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
            </div>

        </main>

        <footer class="text-center mt-8 text-sm text-gray-400">
            <p>&copy; 2024 CLIP with ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</p>
        </footer>

    </div>

    <div id="rules-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">æ ¡æ­£ãƒ«ãƒ¼ãƒ«ä¸€è¦§</h2>
                <p class="text-gray-500 mt-1">ç¾åœ¨ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            </div>
            <div id="rules-list-container" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t text-right rounded-b-2xl">
                <button id="close-modal-button" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition">
                    é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- æ¼¢å­—åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        // â˜…ä¿®æ­£â˜… å¸¸ç”¨æ¼¢å­—ãƒªã‚¹ãƒˆã®ä¸æ­£ãªæ–‡å­—ã‚’å‰Šé™¤
        const joyoKanjiParts = ["äºœå“€æŒ¨æ„›æ›–æ‚ªæ¡åœ§æ‰±å®›åµå®‰æ¡ˆæš—ä»¥è¡£ä½å›²åŒ»ä¾å§”å¨ç‚ºç•èƒƒå°‰ç•°ç§»èå‰",
        "æ¤…å½™æ„é•ç¶­æ…°éºç·¯åŸŸè‚²ä¸€å£±é€¸èŒ¨èŠ‹å¼•å°å› å’½å§»å“¡é™¢æ·«é™°é£²éš éŸ»å³å®‡ç¾½é›¨å”„é¬±ç•æµ¦é‹é›²æ°¸æ³³è‹±æ˜ ",
        "æ „å–¶è© å½±é‹­è¡›æ˜“ç–«ç›Šæ¶²é§…æ‚¦è¶Šè¬é–²å††å»¶æ²¿ç‚æ€¨å®´åª›æ´åœ’ç…™çŒ¿é é‰›å¡©æ¼”ç¸è‰¶æ±šç‹å‡¹å¤®å¿œå¾€æŠ¼æ—ºæ¬§æ®´",
        "æ¡œç¿å¥¥æ¨ªå²¡å±‹å„„æ†¶è‡†è™ä¹™ä¿ºå¸éŸ³æ©æ¸©ç©ä¸‹åŒ–ç«åŠ å¯ä»®ä½•èŠ±ä½³ä¾¡æœæ²³è‹›ç§‘æ¶å¤å®¶è·è¯è“è²¨æ¸¦éå«æš‡ç¦",
        "é´å¯¡æ­Œç®‡ç¨¼èª²èšŠç‰™ç“¦æˆ‘ç”»èŠ½è³€é›…é¤“ä»‹å›ç°ä¼šå¿«æˆ’æ”¹æ€ªæ‹æ‚”æµ·ç•Œçš†æ¢°çµµé–‹éšå¡Šæ¥·è§£æ½°å£Šæ‡è«§è²å¤–åŠ¾å®³å´–",
        "æ¶¯è¡—æ…¨è“‹è©²æ¦‚éª¸å£æŸ¿å„è§’æ‹¡é©æ ¼æ ¸æ®»éƒ­è¦šè¼ƒéš”é–£ç¢ºç²åš‡ç©«å­¦å²³æ¥½é¡é¡æ›æ½Ÿæ‹¬æ´»å–æ¸‡å‰²è‘›æ»‘è¤è½„ä¸”æ ªé‡œéŒåˆˆ",
        "å¹²åˆŠç”˜æ±—ç¼¶å®Œè‚å®˜å† å·»çœ‹é™¥ä¹¾å‹˜æ‚£è²«å¯’å–šå ªæ›æ•¢æ£ºæ¬¾é–“é–‘å‹§å¯›å¹¹æ„Ÿæ¼¢æ…£ç®¡é–¢æ­“ç›£ç·©æ†¾é‚„é¤¨ç’°ç°¡è¦³éŸ“è‰¦é‘‘ä¸¸å«å²¸",
        "å²©ç©çœ¼é ‘é¡”é¡˜ä¼ä¼å±æœºæ°—å²å¸Œå¿Œæ±½å¥‡ç¥ˆå­£ç´€è»Œæ—¢è¨˜èµ·é£¢é¬¼å¸°åŸºå¯„è¦äº€å–œå¹¾æ®æœŸæ£‹è²´æ£„æ¯€æ——å™¨ç•¿è¼æ©Ÿé¨æŠ€å®œå½æ¬ºç¾©ç–‘",
        "å„€æˆ¯æ“¬çŠ è­°èŠå‰å–«è©°å´å®¢è„šé€†è™ä¹ä¹…åŠå¼“ä¸˜æ—§ä¼‘å¸æœ½è‡¼æ±‚ç©¶æ³£æ€¥ç´šç³¾å®®æ•‘çƒçµ¦å—…çª®ç‰›å»å·¨å±…æ‹’æ‹ æŒ™è™šè¨±è·é­šå¾¡æ¼å‡¶å…±",
        "å«ç‹‚äº¬äº«ä¾›å”æ³å³¡æŒŸç‹­ææ­èƒ¸è„…å¼·æ•™éƒ·å¢ƒæ©‹çŸ¯é¡ç«¶éŸ¿é©šä»°æšæ¥­å‡æ›²å±€æ¥µç‰å·¾æ–¤å‡è¿‘é‡‘èŒå‹¤ç´ç­‹åƒ…ç¦ç·ŠéŒ¦è¬¹è¥ŸåŸéŠ€åŒºå¥è‹¦",
        "é§†å…·æƒ§æ„šç©ºå¶é‡éš…ä¸²å±ˆæ˜çªŸç†Šç¹°å›è¨“å‹²è–«è»éƒ¡ç¾¤å…„åˆ‘å½¢ç³»å¾„èŒä¿‚å‹å¥‘è¨ˆæµå•“æ²æ¸“çµŒè›æ•¬æ™¯è»½å‚¾æºç¶™è©£æ…¶æ†¬ç¨½æ†©è­¦é¶èŠ¸è¿é¯¨éš™",
        "åŠ‡æ’ƒæ¿€æ¡æ¬ ç©´è¡€æ±ºçµå‚‘æ½”æœˆçŠ¬ä»¶è¦‹åˆ¸è‚©å»ºç ”çœŒå€¹å…¼å‰£æ‹³è»’å¥é™ºåœå …æ¤œå«ŒçŒ®çµ¹é£æ¨©æ†²è³¢è¬™éµç¹­é¡•é¨“æ‡¸å…ƒå¹»ç„è¨€å¼¦é™åŸç¾èˆ·æ¸›æºå³å·±",
        "æˆ¸å¤å‘¼å›ºè‚¡è™å­¤å¼§æ•…æ¯å€‹åº«æ¹–é›‡èª‡é¼“éŒ®é¡§äº”äº’åˆå‘‰å¾Œå¨¯æ‚Ÿç¢èªèª¤è­·å£å·¥å…¬å‹¾å­”åŠŸå·§åºƒç”²äº¤å…‰å‘åå¥½æ±Ÿè€ƒè¡Œå‘å­æŠ—æ”»æ›´åŠ¹å¹¸æ‹˜è‚¯ä¾¯åšæ’",
        "æ´ªçš‡ç´…è’éƒŠé¦™å€™æ ¡è€•èˆªè²¢é™é«˜åº·æ§æ¢—é»„å–‰æ…Œæ¸¯ç¡¬çµé …æºé‰±æ§‹ç¶±é…µç¨¿èˆˆè¡¡é‹¼è¬›è³¼ä¹å·åˆæ‹·å‰›å‚²è±ªå…‹å‘Šè°·åˆ»å›½é»’ç©€é…·ç„éª¨é§’è¾¼é ƒä»Šå›°æ˜†æ¨æ ¹",
        "å©šæ··ç—•ç´ºé­‚å¢¾æ‡‡å·¦ä½æ²™æŸ»ç ‚å”†å·®è©é–åº§æŒ«æ‰å†ç½å¦»é‡‡ç •å®°æ ½å½©æ¡æ¸ˆç¥­æ–ç´°èœæœ€è£å‚µå‚¬å¡æ­³è¼‰éš›åŸ¼åœ¨æå‰¤è²¡ç½ªå´ä½œå‰Šæ˜¨æŸµç´¢ç­–é…¢æ¾éŒ¯å’²å†Šæœ­åˆ·",
        "åˆ¹æ‹¶æ®ºå¯Ÿæ’®æ“¦é›‘çš¿ä¸‰å±±å‚æ¡Ÿèš•æƒ¨ç”£å‚˜æ•£ç®—é…¸è³›æ®‹æ–¬æš«å£«å­æ”¯æ­¢æ°ä»•å²å¸å››å¸‚çŸ¢æ—¨æ­»ç³¸è‡³ä¼ºå¿—ç§ä½¿åˆºå§‹å§‰æç¥‰è‚¢å§¿æ€æŒ‡æ–½å¸«æ£ç´™è„‚è¦–ç´«è©æ­¯å—£è©¦",
        "è©©è³‡é£¼èªŒé›Œæ‘¯è³œè«®ç¤ºå­—å¯ºæ¬¡è€³è‡ªä¼¼å…äº‹ä¾æ²»æŒæ™‚æ»‹æ…ˆè¾ç£é¤Œç’½é¹¿å¼è­˜è»¸ä¸ƒå±å¤±å®¤ç–¾åŸ·æ¹¿å«‰æ¼†è³ªå®ŸèŠå†™ç¤¾è»Šèˆè€…å°„æ¨èµ¦æ–œç…®é®è¬é‚ªè›‡å°ºå€Ÿé…Œé‡ˆçˆµè‹¥",
        "å¼±å¯‚æ‰‹ä¸»å®ˆæœ±å–ç‹©é¦–æ®Šç é…’è…«ç¨®è¶£å¯¿å—å‘ªæˆéœ€å„’æ¨¹åå›šå·èˆŸç§€å‘¨å®—æ‹¾ç§‹è‡­ä¿®è¢–çµ‚ç¾ç¿’é€±å°±è¡†é›†æ„é…¬é†œè¹´è¥²åæ±å……ä½æŸ”é‡å¾“æ¸‹éŠƒç£ç¸¦å”ç¥å®¿æ·‘ç²›ç¸®å¡¾",
        "ç†Ÿå‡ºè¿°è¡“ä¿Šæ˜¥ç¬æ—¬å·¡ç›¾å‡†æ®‰ç´”å¾ªé †æº–æ½¤éµå‡¦åˆæ‰€æ›¸åº¶æš‘ç½²ç·’è«¸å¥³å¦‚åŠ©åºå™å¾é™¤å°å‡å°‘å¬åŒ åºŠæŠ„è‚–å°šæ‹›æ‰¿æ˜‡æ¾æ²¼æ˜­å®µå°†æ¶ˆç—‡ç¥¥ç§°ç¬‘å”±å•†æ¸‰ç« ç´¹è¨Ÿå‹æŒæ™¶",
        "ç„¼ç„¦ç¡ç²§è©”è¨¼è±¡å‚·å¥¨ç…§è©³å½°éšœæ†§è¡è³å„Ÿç¤é˜ä¸Šä¸ˆå†—æ¡çŠ¶ä¹—åŸæµ„å‰°å¸¸æƒ…å ´ç•³è’¸ç¸„å£Œå¬¢éŒ è­²é†¸è‰²æ‹­é£Ÿæ¤æ®–é£¾è§¦å˜±ç¹”è·è¾±å°»å¿ƒç”³ä¼¸è‡£èŠ¯èº«è¾›ä¾µä¿¡æ´¥ç¥å”‡",
        "å¨ æŒ¯æµ¸çœŸé‡æ·±ç´³é€²æ£®è¨ºå¯æ…æ–°å¯©éœ‡è–ªè¦ªäººåˆƒä»å°½è¿…ç”šé™£å°‹è…é ˆå›³æ°´å¹å‚ç‚Šå¸¥ç²‹è¡°æ¨é…”é‚ç¡ç©‚éšé«„æ¢å´‡æ•°æ®æ‰è£¾å¯¸ç€¬æ˜¯äº•ä¸–æ­£ç”Ÿæˆè¥¿å£°åˆ¶å§“å¾æ€§",
        "é’æ–‰æ”¿æ˜Ÿç‰²çœå‡„é€æ¸…ç››å©¿æ™´å‹¢è–èª ç²¾è£½èª“é™è«‹æ•´é†’ç¨å¤•æ–¥çŸ³èµ¤æ˜”æå¸­è„Šéš»æƒœæˆšè²¬è·¡ç©ç¸¾ç±åˆ‡æŠ˜æ‹™çªƒæ¥è¨­é›ªæ‘‚ç¯€èª¬èˆŒçµ¶åƒå·ä»™å å…ˆå®£å°‚æ³‰æµ…æ´—",
        "æŸ“æ‰‡æ “æ—‹èˆ¹æˆ¦ç…ç¾¨è…ºè©®è·µç®‹éŠ­æ½œç·šé·é¸è–¦ç¹Šé®®å…¨å‰å–„ç„¶ç¦…æ¼¸è†³ç¹•ç‹™é˜»ç¥–ç§Ÿç´ æªç²—çµ„ç–è¨´å¡‘é¡ç¤åŒå£®æ—©äº‰èµ°å¥ç›¸è˜è‰é€å€‰æœæŒ¿æ¡‘å·£æƒæ›¹æ›½çˆ½çª“",
        "å‰µå–ªç—©è‘¬è£…åƒ§æƒ³å±¤ç·é­æ§½è¸ªæ“ç‡¥éœœé¨’è—»é€ åƒå¢—æ†è”µè´ˆè‡“å³æŸè¶³ä¿ƒå‰‡æ¯æ‰é€Ÿå´æ¸¬ä¿—æ—å±è³Šç¶šå’ç‡å­˜æ‘å­«å°Šæéœä»–å¤šæ±°æ‰“å¦¥å”¾å •æƒ°é§„å¤ªå¯¾ä½“è€å¾…æ€ ",
        "èƒé€€å¸¯æ³°å †è¢‹é€®æ›¿è²¸éšŠæ»æ…‹æˆ´å¤§ä»£å°ç¬¬é¡Œæ»å®…æŠæ²¢å“æ‹“è¨—æ¿¯è«¾æ¿ä½†é”è„±å¥ªæ£šèª°ä¸¹æ—¦æ‹…å˜ç‚­èƒ†æ¢æ·¡çŸ­å˜†ç«¯ç¶»èª•é›å›£ç”·æ®µæ–­å¼¾æš–è«‡å£‡åœ°æ± çŸ¥å€¤æ¥è‡´",
        "é…ç—´ç¨šç½®ç·»ç«¹ç•œé€è“„ç¯‰ç§©çª’èŒ¶ç€å«¡ä¸­ä»²è™«æ²–å®™å¿ æŠ½æ³¨æ˜¼æŸ±è¡·é…é‹³é§è‘—è²¯ä¸å¼”åºå…†ç”ºé•·æŒ‘å¸³å¼µå½«çœºé‡£é ‚é³¥æœè²¼è¶…è…¸è·³å¾´å˜²æ½®æ¾„èª¿è´æ‡²ç›´å‹…æ—æ²ˆ",
        "çæœ•é™³è³ƒé®è¿½æ¤å¢œé€šç—›å¡šæ¼¬åªçˆªé¶´ä½å‘ˆå»·å¼Ÿå®šåº•æŠµé‚¸äº­è²å¸è¨‚åº­é€“åœåµå ¤æç¨‹è‰‡ç· è«¦æ³¥çš„ç¬›æ‘˜æ»´é©æ•µæººè¿­å“²é‰„å¾¹æ’¤å¤©å…¸åº—ç‚¹å±•æ·»è»¢å¡«ç”°ä¼æ®¿",
        "é›»æ–—åå¦¬å¾’é€”éƒ½æ¸¡å¡—è³­åœŸå¥´åŠªåº¦æ€’åˆ€å†¬ç¯å½“æŠ•è±†æ±åˆ°é€ƒå€’å‡å”å³¶æ¡ƒè¨é€å…šæ‚¼ç›—é™¶å¡”æ­æ£Ÿæ¹¯ç—˜ç™»ç­”ç­‰ç­’çµ±ç¨²è¸ç³–é ­è¬„è—¤é—˜é¨°åŒæ´èƒ´å‹•å ‚ç«¥é“åƒéŠ…",
        "å°ç³å³ åŒ¿ç‰¹å¾—ç£å¾³ç¯¤æ¯’ç‹¬èª­æ ƒå‡¸çªå±Šå±¯è±šé “è²ªéˆæ›‡ä¸¼é‚£å¥ˆå†…æ¢¨è¬é‹å—è»Ÿé›£äºŒå°¼å¼åŒ‚è‚‰è™¹æ—¥å…¥ä¹³å°¿ä»»å¦Šå¿èªå¯§ç†±å¹´å¿µæ»ç²˜ç‡ƒæ‚©ç´èƒ½è„³è¾²æ¿ƒæŠŠæ³¢æ´¾ç ´",
        "è¦‡é¦¬å©†ç½µæ‹æ¯èƒŒè‚ºä¿³é…æ’æ•—å»ƒè¼©å£²å€æ¢…åŸ¹é™ªåª’è²·è³ ç™½ä¼¯æ‹æ³Šè¿«å‰¥èˆ¶åšè–„éº¦æ¼ ç¸›çˆ†ç®±ç®¸ç•‘è‚Œå…«é‰¢ç™ºé«ªä¼æŠœç½°é–¥ååŠæ°¾çŠ¯å¸†æ±ä¼´åˆ¤å‚é˜ªæ¿ç‰ˆç­ç•”èˆ¬è²©æ–‘",
        "é£¯æ¬ç…©é ’ç¯„ç¹è—©æ™©ç•ªè›®ç›¤æ¯”çš®å¦ƒå¦æ‰¹å½¼æŠ«è‚¥éå‘é£›ç–²ç§˜è¢«æ‚²æ‰‰è²»ç¢‘ç½·é¿å°¾çœ‰ç¾å‚™å¾®é¼»è†è‚˜åŒ¹å¿…æ³Œç­†å§«ç™¾æ°·è¡¨ä¿µç¥¨è©•æ¼‚æ¨™è‹—ç§’ç—…æçŒ«å“æµœè²§è³“é »æ•ç“¶",
        "ä¸å¤«çˆ¶ä»˜å¸ƒæ‰¶åºœæ€–é˜œé™„è¨ƒè² èµ´æµ®å©¦ç¬¦å¯Œæ™®è…æ•·è†šè³¦è­œä¾®æ­¦éƒ¨èˆå°é¢¨ä¼æœå‰¯å¹…å¾©ç¦è…¹è¤‡è¦†æ‰•æ²¸ä»ç‰©ç²‰ç´›é›°å™´å¢³æ†¤å¥®åˆ†æ–‡èä¸™å¹³å…µä½µä¸¦æŸ„é™›é–‰å¡€å¹£å¼Šè”½",
        "é¤…ç±³å£ç’§ç™–åˆ¥è”‘ç‰‡è¾ºè¿”å¤‰åéç·¨å¼ä¾¿å‹‰æ­©ä¿å“ºæ•è£œèˆ—æ¯å‹Ÿå¢“æ…•æš®ç°¿æ–¹åŒ…èŠ³é‚¦å¥‰å®æŠ±æ”¾æ³•æ³¡èƒä¿¸å€£å³°ç ²å´©è¨ªå ±èœ‚è±Šé£½è¤’ç¸«äº¡ä¹å¿™åŠå¦¨å¿˜é˜²æˆ¿è‚ªæŸå†’å‰–",
        "ç´¡æœ›å‚å¸½æ£’è²¿è²Œæš´è†¨è¬€é ¬åŒ—æœ¨æœ´ç‰§ç¦åƒ•å¢¨æ’²æ²¡å‹ƒå €æœ¬å¥”ç¿»å‡¡ç›†éº»æ‘©ç£¨é­”æ¯å¦¹æšæ˜§åŸ‹å¹•è†œæ•åˆæœ«æŠ¹ä¸‡æº€æ…¢æ¼«æœªå‘³é­…å²¬å¯†èœœè„ˆå¦™æ°‘çœ çŸ›å‹™ç„¡å¤¢éœ§å¨˜åå‘½",
        "æ˜è¿·å†¥ç›ŸéŠ˜é³´æ»…å…é¢ç¶¿éººèŒ‚æ¨¡æ¯›å¦„ç›²è€—çŒ›ç¶²ç›®é»™é–€ç´‹å•å†¶å¤œé‡å¼¥å„å½¹ç´„è¨³è–¬èºé—‡ç”±æ²¹å–©æ„‰è«­è¼¸ç™’å”¯å‹æœ‰å‹‡å¹½æ‚ éƒµæ¹§çŒ¶è£•éŠé›„èª˜æ†‚èå„ªä¸äºˆä½™èª‰é å¹¼",
        "ç”¨ç¾Šå¦–æ´‹è¦å®¹åº¸æšæºè‘‰é™½æº¶è…°æ§˜ç˜è¸Šçª¯é¤Šæ“è¬¡æ›œæŠ‘æ²ƒæµ´æ¬²ç¿Œç¿¼æ‹‰è£¸ç¾…æ¥é›·é ¼çµ¡è½é…ªè¾£ä¹±åµè¦§æ¿«è—æ¬„ååˆ©é‡Œç†ç—¢è£å±¥ç’ƒé›¢é™¸ç«‹å¾‹æ…„ç•¥æŸ³æµç•™ç«œç²’éš†ç¡«",
        "ä¾¶æ—…è™œæ…®äº†ä¸¡è‰¯æ–™æ¶¼çŒŸé™µé‡åƒšé ˜å¯®ç™‚ç­ç³§åŠ›ç·‘æ—å˜å€«è¼ªéš£è‡¨ç‘ æ¶™ç´¯å¡é¡ä»¤ç¤¼å†·åŠ±æˆ»ä¾‹éˆ´é›¶éœŠéš·é½¢éº—æš¦æ­´åˆ—åŠ£çƒˆè£‚æ‹é€£å»‰ç·´éŒ¬å‘‚ç‚‰è³‚è·¯éœ²è€åŠ´å¼„éƒæœ—",
        "æµªå»Šæ¥¼æ¼ç± å…­éŒ²éº“è«–å’Œè©±è³„è„‡æƒ‘æ æ¹¾è…•"];
        const joyoKanjiSet = new Set(joyoKanjiParts.join('').split(''));
        const clipSpecificAllowedKanji = new Set(['æ‡‰', 'çµ†', 'å‰‡', 'å¶', 'å¬‰']);
        function isAllowedKanji(char) { return joyoKanjiSet.has(char) || clipSpecificAllowedKanji.has(char); }

        // --- æ ¡æ­£ãƒ«ãƒ¼ãƒ«ã®å®šç¾© ---
        const proofreadingRules = [
            { type: 'replace', find: /ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿(?!ãƒ¼)/g, replace: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼', reason: 'ã‚«ã‚¿ã‚«ãƒŠèªã®é•·éŸ³ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ã€Œã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ãƒ¦ãƒ¼ã‚¶(?!ãƒ¼)/g, replace: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', reason: 'ã‚«ã‚¿ã‚«ãƒŠèªã®é•·éŸ³ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /:(\d)(?!\d)/g, replace: (match, p1) => `:0${p1}`, reason: 'æ™‚åˆ»ã®ã€Œåˆ†ã€ãŒ1æ¡ã®å ´åˆã¯ã€å…ˆé ­ã«0ã‚’è¿½åŠ ã—ã¾ã™ã€‚(ä¾‹: 9:05)' },
            { type: 'replace', find: /ä»Šå¹´åº¦/g, replace: 'æœ¬å¹´åº¦', reason: 'ã€Œä»Šå¹´åº¦ã€ã¯ä½¿ã‚ãšã€ã€Œæœ¬å¹´åº¦ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /æ˜å¹´åº¦/g, replace: 'æ¥å¹´åº¦', reason: 'ã€Œæ˜å¹´åº¦ã€ã¯ä½¿ã‚ãšã€ã€Œæ¥å¹´åº¦ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /\[ã“ã¡ã‚‰\]/g, reason: 'ãƒªãƒ³ã‚¯å…ˆãŒã‚ã‹ã‚Šã«ãã„ã‚¢ãƒ³ã‚«ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã¯é¿ã‘ã‚‹ã¹ãã§ã™ã€‚ã€Œã“ã¡ã‚‰ã€ã§ã¯ãªãã€ãƒªãƒ³ã‚¯å…ˆã®ã‚¿ã‚¤ãƒˆãƒ«ãªã©ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚' },
            { type: 'replace', find: /ã€œ/g, replace: '-', reason: 'æ•°å­—ãƒ»æ—¥ä»˜ã®ç¯„å›²ã‚’è¡¨ã™ã«ã¯åŠè§’ãƒã‚¤ãƒ•ãƒ³ã€Œ-ã€ã‚’ä½¿ã„ã¾ã™ã€‚' },
            { type: 'replace', find: /,/g, replace: 'ã€', reason: 'èª­ç‚¹ã¯å…¨è§’ã€Œã€ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚åŠè§’ã‚«ãƒ³ãƒã¯ä¿®æ­£å¯¾è±¡ã§ã™ã€‚' },
            { type: 'replace', find: /ï½¢/g, replace: 'ã€Œ', reason: 'ã‚«ã‚®æ‹¬å¼§ã¯å…¨è§’ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ï½£/g, replace: 'ã€', reason: 'ã‚«ã‚®æ‹¬å¼§ã¯å…¨è§’ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ï½¥/g, replace: 'ãƒ»', reason: 'ä¸­ç‚¹ã¯å…¨è§’ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /ä½†ã—/g, reason: 'ã€Œä½†ã—ã€ã¯ä½¿ã‚ãšã€ã²ã‚‰ãŒãªã§ã€ŒãŸã ã—ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /åˆ/g, reason: 'ã€Œåˆã€ã¯ä½¿ã‚ãšã€ã²ã‚‰ãŒãªã§ã€Œã¾ãŸã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /å› ã‚‹/g, reason: 'ã€Œå› ã‚‹ã€ã¯ä½¿ã‚ãšã€ã²ã‚‰ãŒãªã§ã€Œã‚ˆã‚‹ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /é¡ã‚‹/g, reason: 'ã€Œé¡ã‚‹ã€ã¯ä½¿ã‚ãšã€ã²ã‚‰ãŒãªã§ã€Œã•ã‹ã®ã¼ã‚‹ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /æ…¶æ‡‰ç”Ÿ/g, replace: 'å¡¾ç”Ÿ', reason: 'ã€Œæ…¶æ‡‰ç”Ÿã€ã¯ã€Œå¡¾ç”Ÿã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /å…ƒæ—¦ã®æœ/g, reason: 'ã€Œå…ƒæ—¦ã€ã¯å…ƒæ—¥ã®æœã‚’æŒ‡ã™ãŸã‚ã€ã€Œã®æœã€ã¯ä¸è¦ã§ã™ã€‚ã€Œå…ƒæ—¦ã€ã¾ãŸã¯ã€Œå…ƒæ—¥ã€ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚' },
            { type: 'warning', find: /éåŠæ•°ã‚’è¶…ãˆã‚‹/g, reason: 'ã€ŒéåŠæ•°ã€ã¯åŠåˆ†ã‚’è¶…ãˆã‚‹ã¨ã„ã†æ„å‘³ã§ã™ã€‚ã€ŒéåŠæ•°ã‚’å ã‚ã‚‹ã€ãªã©ã®è¡¨ç¾ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' },
            { type: 'replace', find: /æ…¶å¿œ/g, replace: 'æ…¶æ‡‰', reason: 'ã€Œæ…¶å¿œã€ã¯ã€Œæ…¶æ‡‰ã€ã«ä¿®æ­£ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ä¸€äººä¸€äºº/g, replace: 'ä¸€äººã²ã¨ã‚Š', reason: 'ã€Œä¸€äººä¸€äººã€ã¯ã€Œä¸€äººã²ã¨ã‚Šã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ï¼ˆ/g, replace: '(', reason: 'æ‹¬å¼§ã¯åŠè§’ã«ä¿®æ­£ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ï¼‰/g, replace: ')', reason: 'æ‹¬å¼§ã¯åŠè§’ã«ä¿®æ­£ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ï¼Œ/g, replace: 'ã€', reason: 'èª­ç‚¹ã¯å…¨è§’ã€Œã€ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /[ï¼Ÿï¼]/g, replace: (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0), reason: 'ç–‘å•ç¬¦ãƒ»æ„Ÿå˜†ç¬¦ã¯åŠè§’ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /[ï¼ï½¡]/g, replace: 'ã€‚', reason: 'å¥ç‚¹ã¯å…¨è§’ã€Œã€‚ã€ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /æ§˜ã€…/g, replace: 'ã•ã¾ã–ã¾', reason: 'ã€Œæ§˜ã€…ã€ã¯ã²ã‚‰ãŒãªã§ã€Œã•ã¾ã–ã¾ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /è‰²ã€…/g, replace: 'ã„ã‚ã„ã‚', reason: 'ã€Œè‰²ã€…ã€ã¯ã²ã‚‰ãŒãªã§ã€Œã„ã‚ã„ã‚ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /å„ã€…/g, replace: 'ãŠã®ãŠã®', reason: 'ã€Œå„ã€…ã€ã¯ã²ã‚‰ãŒãªã§ã€ŒãŠã®ãŠã®ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /ç§é”/g, replace: 'ç§ãŸã¡', reason: 'ã€Œç§é”ã€ã¯ã€Œç§ãŸã¡ã€ã¨è¡¨è¨˜ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚' },
            { type: 'replace', find: /ã—ã¦æ¬²ã—ã„/g, replace: 'ã—ã¦ã»ã—ã„', reason: 'è£œåŠ©å‹•è©ã®ã€Œã»ã—ã„ã€ã¯ã²ã‚‰ãŒãªã§è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /è³‘ã‚ã„/g, replace: 'ã«ãã‚ã„', reason: 'ã€Œè³‘ã‚ã„ã€ã¯ã²ã‚‰ãŒãªã§ã€Œã«ãã‚ã„ã€ã¨è¡¨è¨˜ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚' },
            { type: 'replace', find: /ãŠç–²ã‚Œæ§˜/g, replace: 'ãŠç–²ã‚Œã•ã¾', reason: 'ã€ŒãŠç–²ã‚Œæ§˜ã€ã¯ã€ŒãŠç–²ã‚Œã•ã¾ã€ã¨ã²ã‚‰ãŒãªã§è¡¨è¨˜ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚' },
            { type: 'replace', find: /çš„ã‚’å¾—ã‚‹/g, replace: 'çš„ã‚’å°„ã‚‹', reason: 'ã€Œçš„ã‚’å¾—ã‚‹ã€ã¯èª¤ç”¨ã§ã™ã€‚ã€Œçš„ã‚’å°„ã‚‹ã€ãŒæ­£ã—ã„è¡¨ç¾ã§ã™ã€‚' },
            { type: 'replace', find: /é•å’Œæ„Ÿã‚’æ„Ÿã˜ã‚‹/g, replace: 'é•å’Œæ„Ÿã‚’è¦šãˆã‚‹', reason: 'ã€Œé•å’Œæ„Ÿã‚’æ„Ÿã˜ã‚‹ã€ã¯äºŒé‡è¡¨ç¾ã§ã™ã€‚ã€Œé•å’Œæ„Ÿã‚’è¦šãˆã‚‹ã€ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚' },
            { type: 'replace', find: /æ…¶æ—©/g, replace: 'æ—©æ…¶', reason: 'ã€Œæ…¶æ—©ã€ã§ã¯ãªãã€Œæ—©æ…¶ã€ã¨è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'replace', find: /[ï¼-ï¼™]/g, replace: (match) => String.fromCharCode(match.charCodeAt(0) - 0xFEE0), reason: 'æ•°å­—ã¯åŠè§’ã§è¡¨è¨˜ã—ã¾ã™ã€‚' },
            { type: 'warning', find: /æ˜¨æ—¥|ä»Šæ—¥|æ˜æ—¥|ä»Šæœ|æ˜¨å¤œ/g, reason: 'ç›¸å¯¾çš„ãªæ—¥ä»˜è¡¨ç¾ã§ã™ã€‚å…¬é–‹æ—¥ã«ã‚ˆã£ã¦ã¯æ„å›³ã—ãªã„æ—¥ä»˜ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã€Œã€‡æœˆã€‡æ—¥ã€ã®ã‚ˆã†ãªçµ¶å¯¾çš„ãªè¡¨è¨˜ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' },
        ];

        // --- HTMLè¦ç´ ã®å–å¾— ---
        const textInput = document.getElementById('text-input');
        const checkButton = document.getElementById('check-button');
        const geminiProofreadButton = document.getElementById('gemini-proofread-button');
        const geminiSnsButton = document.getElementById('gemini-sns-button');
        const geminiPhraseButton = document.getElementById('gemini-phrase-button');
        const resultArea = document.getElementById('result-area');
        const highlightedOutput = document.getElementById('highlighted-output');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const geminiResultTitle = document.getElementById('gemini-result-title');
        const geminiResultArea = document.getElementById('gemini-result-area');
        const viewRulesButton = document.getElementById('view-rules-button');
        const rulesModal = document.getElementById('rules-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const rulesListContainer = document.getElementById('rules-list-container');

        // --- Gemini APIé€£æº ---
        async function callGeminiApi(text, mode) {
            console.log(`Gemini APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™... ãƒ¢ãƒ¼ãƒ‰: ${mode}`);
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let systemPrompt, responseSchema;

            if (mode === 'proofread') {
                systemPrompt = `ã‚ãªãŸã¯ã€æ…¶æ‡‰ç¾©å¡¾å¤§å­¦SFCã®Webãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ã‚¯ãƒ«ã€ŒSFC CLIPã€ã®å„ªç§€ãªç·¨é›†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ¸¡ã•ã‚ŒãŸè¨˜äº‹ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æã—ã€ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§ã¯æ¤œå‡ºã§ããªã„ã€æ–‡ç« ã®ãƒˆãƒ¼ãƒ³ã€æ§‹æˆã€è¡¨ç¾ã®è‡ªç„¶ã•ãªã©ã«é–¢ã™ã‚‹ã€ã‚ˆã‚Šé«˜åº¦ã§äººé–“çš„ãªæ ¡æ­£ææ¡ˆã‚’ç®‡æ¡æ›¸ãã®é…åˆ—ã§æä¾›ã—ã¦ãã ã•ã„ã€‚`;
                responseSchema = {
                    type: "OBJECT",
                    properties: {
                        advancedFeedback: { type: "ARRAY", items: { type: "STRING" } }
                    }
                };
            } else if (mode === 'sns') {
                systemPrompt = `ã‚ãªãŸã¯ã€æ…¶æ‡‰ç¾©å¡¾å¤§å­¦SFCã®Webãƒ¡ãƒ‡ã‚£ã‚¢ã‚µãƒ¼ã‚¯ãƒ«ã€ŒSFC CLIPã€ã®å„ªç§€ãªç·¨é›†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚æ¸¡ã•ã‚ŒãŸè¨˜äº‹ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ†æã—ã€ä»¥ä¸‹ã®3ã¤ã®é …ç›®ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
                1. summary: è¨˜äº‹å…¨ä½“ã®ç°¡æ½”ãªè¦ç´„ã€‚
                2. twitterPost: è¨˜äº‹ã‚’å®£ä¼ã™ã‚‹ãŸã‚ã®X(æ—§Twitter)ç”¨ã®æŠ•ç¨¿æ¡ˆã€‚ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’åŠ¹æœçš„ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚
                3. instagramPost: è¨˜äº‹ã‚’å®£ä¼ã™ã‚‹ãŸã‚ã®Instagramç”¨ã®æŠ•ç¨¿æ¡ˆã€‚çµµæ–‡å­—ã‚’åŠ¹æœçš„ã«ä½¿ç”¨ã—ã€èª­è€…ã®èˆˆå‘³ã‚’å¼•ãã‚ˆã†ã«å·¥å¤«ã™ã‚‹ã“ã¨ã€‚`;
                responseSchema = {
                    type: "OBJECT",
                    properties: {
                        summary: { type: "STRING" },
                        twitterPost: { type: "STRING" },
                        instagramPost: { type: "STRING" }
                    }
                };
            } else if (mode === 'phrase') {
                systemPrompt = `ã‚ãªãŸã¯å„ªç§€ãªæ—¥æœ¬èªç·¨é›†è€…ã§ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆå†…ã®ä¸è‡ªç„¶ãªè¨€ã„å›ã—ã€é‡è¤‡è¡¨ç¾ã€å†—é•·ãªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’æ¤œå‡ºã—ã¦ãã ã•ã„ã€‚çµæœã¯æŒ‡å®šã•ã‚ŒãŸJSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦é…åˆ—ã§è¿”ã—ã¦ãã ã•ã„ã€‚`;
                responseSchema = {
                    type: "OBJECT",
                    properties: {
                        phraseCorrections: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    original: { type: "STRING" },
                                    suggestion: { type: "STRING" },
                                    reason: { type: "STRING" }
                                }
                            }
                        }
                    }
                };
            }

            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const rawText = candidate.content.parts[0].text;
                    console.log("APIã‹ã‚‰å—ä¿¡ã—ãŸç”Ÿãƒ†ã‚­ã‚¹ãƒˆ:", rawText);
                    try {
                        return JSON.parse(rawText);
                    } catch (parseError) {
                        console.error("JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ:", parseError, "å—ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ:", rawText);
                        throw new Error(`AIãŒä¸æ­£ãªå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã—ãŸã€‚`);
                    }
                } else {
                    if (mode === 'phrase') return { phraseCorrections: [] };
                    return null;
                }
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    console.error("APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
                    throw new Error("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ–‡ç« ãŒé•·ã™ãã‚‹ã‹ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                }
                console.error("Gemini APIã®å‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                throw error;
            }
        }
        
        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        geminiProofreadButton.addEventListener('click', async () => {
            const originalText = textInput.value;
            if (!originalText) { alert('æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

            geminiResultContainer.classList.remove('hidden');
            geminiResultTitle.textContent = 'âœ¨ Geminiã«ã‚ˆã‚‹é«˜åº¦ãªæ ¡æ­£æ¡ˆ';
            geminiResultTitle.className = 'text-2xl font-bold mb-4 text-gray-800 border-b-2 border-purple-200 pb-2';
            geminiResultArea.innerHTML = `<div class="flex items-center justify-center gap-3 text-purple-700"><div class="loader" style="border-top-color: #8b5cf6;"></div><p>GeminiãŒæ–‡ç« ã‚’è§£æä¸­ã§ã™...</p></div>`;

            try {
                const aiResponse = await callGeminiApi(originalText, 'proofread');
                if (aiResponse && aiResponse.advancedFeedback && aiResponse.advancedFeedback.length > 0) {
                    geminiResultArea.innerHTML = `
                        <ul class="list-disc list-inside text-gray-800 space-y-1">
                            ${aiResponse.advancedFeedback.map(item => `<li>${item}</li>`).join('')}
                        </ul>`;
                } else {
                    geminiResultArea.innerHTML = `<p class="text-gray-500">ç‰¹ã«ææ¡ˆäº‹é …ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                }
            } catch (error) {
                geminiResultArea.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        });

        geminiSnsButton.addEventListener('click', async () => {
            const originalText = textInput.value;
            if (!originalText) { alert('æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }

            geminiResultContainer.classList.remove('hidden');
            geminiResultTitle.textContent = 'ğŸ“ Geminiã«ã‚ˆã‚‹SNSæŠ•ç¨¿æ¡ˆ';
            geminiResultTitle.className = 'text-2xl font-bold mb-4 text-gray-800 border-b-2 border-green-200 pb-2';
            geminiResultArea.innerHTML = `<div class="flex items-center justify-center gap-3 text-green-700"><div class="loader" style="border-top-color: #10b981;"></div><p>GeminiãŒSNSæŠ•ç¨¿æ¡ˆã‚’ä½œæˆä¸­ã§ã™...</p></div>`;

            try {
                const aiResponse = await callGeminiApi(originalText, 'sns');
                geminiResultArea.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">è¨˜äº‹ã®è¦ç´„</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md text-gray-800">${aiResponse.summary}</div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">X (æ—§Twitter) æŠ•ç¨¿æ¡ˆ</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md relative">
                                <pre class="whitespace-pre-wrap font-sans">${aiResponse.twitterPost}</pre>
                                <button onclick="copyToClipboard(this.previousElementSibling.textContent)" class="absolute top-2 right-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-300">ã‚³ãƒ”ãƒ¼</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-700">Instagram æŠ•ç¨¿æ¡ˆ</h3>
                            <div class="mt-2 p-3 bg-gray-100 rounded-md relative">
                                <pre class="whitespace-pre-wrap font-sans">${aiResponse.instagramPost}</pre>
                                <button onclick="copyToClipboard(this.previousElementSibling.textContent)" class="absolute top-2 right-2 bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded hover:bg-gray-300">ã‚³ãƒ”ãƒ¼</button>
                            </div>
                        </div>
                    </div>`;
            } catch (error) {
                geminiResultArea.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        });

        geminiPhraseButton.addEventListener('click', async () => {
            let originalText = textInput.value;
            if (!originalText) { alert('æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
            
            const MAX_CHARS_PHRASE = 2000;
            if (originalText.length > MAX_CHARS_PHRASE) {
                alert(`ãƒ•ãƒ¬ãƒ¼ã‚ºãƒã‚§ãƒƒã‚¯ã¯${MAX_CHARS_PHRASE}æ–‡å­—ã¾ã§ã§ã™ã€‚æ–‡ç« ãŒé•·ã™ãã‚‹ãŸã‚ã€æœ€åˆã®${MAX_CHARS_PHRASE}æ–‡å­—ã®ã¿ã‚’å‡¦ç†ã—ã¾ã™ã€‚`);
                originalText = originalText.substring(0, MAX_CHARS_PHRASE);
            }

            geminiResultContainer.classList.remove('hidden');
            geminiResultTitle.textContent = 'ğŸ” Geminiã«ã‚ˆã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã®ãƒã‚§ãƒƒã‚¯çµæœ';
            geminiResultTitle.className = 'text-2xl font-bold mb-4 text-gray-800 border-b-2 border-orange-200 pb-2';
            geminiResultArea.innerHTML = `<div class="flex items-center justify-center gap-3 text-orange-700"><div class="loader" style="border-top-color: #f97316;"></div><p>GeminiãŒä¸è‡ªç„¶ãªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’æ¤œå‡ºä¸­ã§ã™...</p></div>`;

            try {
                const aiResponse = await callGeminiApi(originalText, 'phrase');
                if (aiResponse && aiResponse.phraseCorrections && aiResponse.phraseCorrections.length > 0) {
                    let html = '<div class="space-y-4">';
                    aiResponse.phraseCorrections.forEach(item => {
                        html += `
                            <div class="suggestion-card border-orange-400 bg-orange-50 p-4">
                                <p class="font-semibold text-gray-800">æŒ‡æ‘˜ãƒ•ãƒ¬ãƒ¼ã‚ºï¼š <code class="bg-red-100 text-red-700 rounded px-1">${item.original}</code></p>
                                <p class="text-gray-600 mt-1">ä¿®æ­£æ¡ˆï¼š <code class="bg-green-100 text-green-700 rounded px-1">${item.suggestion}</code></p>
                                <p class="text-sm text-gray-500 mt-2">ç†ç”±ï¼š ${item.reason}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                    geminiResultArea.innerHTML = html;
                } else {
                    geminiResultArea.innerHTML = `<p class="text-gray-500">ç‰¹ã«ä¸è‡ªç„¶ãªãƒ•ãƒ¬ãƒ¼ã‚ºã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                }
            } catch (error) {
                geminiResultArea.innerHTML = `<p class="text-red-500">${error.message}</p>`;
            }
        });


        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }

        checkButton.addEventListener('click', () => {
            const originalText = textInput.value;
            if (!originalText) {
                resultArea.innerHTML = `<p class="text-red-500 text-center">æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>`;
                highlightedOutput.innerHTML = `<p class="text-gray-400">æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>`;
                return;
            }

            resultArea.innerHTML = '';
            let issuesFound = 0;
            const matchesToHighlight = [];

            proofreadingRules.forEach(rule => {
                const matches = [...originalText.matchAll(rule.find)];
                if (matches.length > 0) {
                    issuesFound += matches.length;
                    matches.forEach(match => {
                        matchesToHighlight.push({ index: match.index, text: match[0], type: rule.type });
                        displaySuggestion(match[0], rule);
                    });
                }
            });

            const foundBadKanji = new Set();
            const kanjiRegex = /[\u4e00-\u9faf\u3400-\u4dbf]/g;
            let match;
            while ((match = kanjiRegex.exec(originalText)) !== null) {
                const char = match[0];
                if (!isAllowedKanji(char) && !foundBadKanji.has(char)) {
                    issuesFound++;
                    const reason = `ã€Œ${char}ã€ã¯å¸¸ç”¨æ¼¢å­—ã§ã¯ãªã„ã‹ã€CLIPã®è¦å®šå¤–ã®æ¼¢å­—ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã²ã‚‰ãŒãªã«ã™ã‚‹ã‹ã€åˆ¥ã®è¡¨ç¾ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`;
                    matchesToHighlight.push({ index: match.index, text: char, type: 'warning' });
                    displaySuggestion(char, { type: 'warning', reason: reason });
                    foundBadKanji.add(char);
                }
            }

            updateHighlightedOutput(originalText, matchesToHighlight, issuesFound);

            if (issuesFound === 0) {
                resultArea.innerHTML = `
                    <div class="text-center p-6 border-green-500 bg-green-50 rounded-lg">
                        <p class="font-bold text-green-700 text-lg">ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼</p>
                        <p class="text-green-600">å®šç¾©ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã«è©²å½“ã™ã‚‹ç®‡æ‰€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    </div>
                `;
            }
        });
        
        function displaySuggestion(matchedText, rule) {
            const card = document.createElement('div');
            card.className = 'suggestion-card border-l-4 p-4';
            
            if (rule.type === 'warning') {
                card.classList.add('border-yellow-500', 'bg-yellow-50');
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">ã€è­¦å‘Šã€‘ <code class="bg-yellow-200 text-yellow-800 rounded px-1">${matchedText}</code></p>
                    <p class="text-sm text-gray-600 mt-2">${rule.reason}</p>
                `;
            } else {
                const replacementText = typeof rule.replace === 'function' ? rule.replace(matchedText) : rule.replace;
                card.classList.add('border-blue-500', 'bg-blue-50');
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">æŒ‡æ‘˜ç®‡æ‰€ï¼š <code class="bg-red-100 text-red-700 rounded px-1">${matchedText}</code></p>
                    <p class="text-gray-600 mt-1">ä¿®æ­£å€™è£œï¼š <code class="bg-green-100 text-green-700 rounded px-1">${replacementText}</code></p>
                    <p class="text-sm text-gray-500 mt-2">ç†ç”±ï¼š ${rule.reason}</p>
                `;
            }
            resultArea.appendChild(card);
        }

        function updateHighlightedOutput(text, matches, issuesFound) {
            if (issuesFound > 0) {
                matches.sort((a, b) => b.index - a.index);
                let highlightedHTML = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                matches.forEach(match => {
                    const head = highlightedHTML.substring(0, match.index);
                    const tail = highlightedHTML.substring(match.index + match.text.length);
                    const markText = match.text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    const className = match.type === 'warning' ? 'warning' : 'replace';
                    highlightedHTML = `${head}<mark class="${className}">${markText}</mark>${tail}`;
                });
                highlightedOutput.innerHTML = highlightedHTML.replace(/\n/g, '<br>');
            } else {
                highlightedOutput.innerHTML = `<p class="text-gray-400">æŒ‡æ‘˜äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
            }
        }

        function populateRulesList() {
            let html = '<div class="space-y-4">';
            html += `
                <div class="p-4 border rounded-lg bg-white shadow-sm">
                    <p class="font-mono text-sm">
                        <span class="text-yellow-600 bg-yellow-100 rounded px-2 py-1">å¸¸ç”¨æ¼¢å­—å¤–ã®æ–‡å­—</span>
                        <span class="mx-2 text-gray-400">&rarr;</span>
                        <span class="text-gray-600 rounded px-2 py-1">è­¦å‘Šã‚’è¡¨ç¤º</span>
                    </p>
                    <p class="text-sm text-gray-600 mt-2">å¸¸ç”¨æ¼¢å­—ã¨CLIPã§è¨±å¯ã•ã‚ŒãŸæ¼¢å­—ä»¥å¤–ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹å ´åˆã«è­¦å‘Šã—ã¾ã™ã€‚</p>
                </div>
            `;
            proofreadingRules.forEach(rule => {
                const findText = rule.find.toString().replace(/^\/|\/g$/g, '');
                let replacementHTML;
                if (rule.type === 'warning') {
                    replacementHTML = `<span class="text-gray-600 rounded px-2 py-1">è­¦å‘Šã‚’è¡¨ç¤º</span>`;
                } else {
                    const replacementText = typeof rule.replace === 'function' ? '(è‡ªå‹•å¤‰æ›)' : rule.replace;
                    replacementHTML = `<span class="text-green-600 bg-green-100 rounded px-2 py-1">${replacementText}</span>`;
                }

                html += `
                    <div class="p-4 border rounded-lg bg-white shadow-sm">
                        <p class="font-mono text-sm">
                            <span class="text-red-600 bg-red-100 rounded px-2 py-1">${findText}</span>
                            <span class="mx-2 text-gray-400">&rarr;</span>
                            ${replacementHTML}
                        </p>
                        <p class="text-sm text-gray-600 mt-2">${rule.reason}</p>
                    </div>
                `;
            });
            html += '</div>';
            rulesListContainer.innerHTML = html;
        }

        viewRulesButton.addEventListener('click', () => rulesModal.classList.remove('hidden'));
        closeModalButton.addEventListener('click', () => rulesModal.classList.add('hidden'));
        rulesModal.addEventListener('click', (event) => {
            if (event.target === rulesModal) rulesModal.classList.add('hidden');
        });

        populateRulesList();
    </script>
</body>
</html>
